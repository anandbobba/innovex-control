<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INNOVEX Controller</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);color:#fff;padding:20px;min-height:100vh}
    .container{max-width:1200px;margin:0 auto}
    h1{text-align:center;margin-bottom:10px;font-size:2.5rem;color:#ff4757;text-shadow:0 0 20px rgba(255,71,87,.5)}
    .subtitle{text-align:center;margin-bottom:30px;color:#dfe6e9;font-size:1.1rem}
    .status-box{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:15px;padding:20px;margin-bottom:30px;backdrop-filter:blur(10px)}
    .status-box h2{margin-bottom:15px;font-size:1.5rem;color:#ffd700}
    .status-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.1)}
    .status-item:last-child{border-bottom:none}
    .status-label{font-weight:600;color:#b2bec3}
    .status-value{color:#74b9ff;font-weight:700}
    .connection-status{display:inline-block;padding:5px 15px;border-radius:20px;font-size:.9rem;font-weight:700}
    .connection-status.connected{background:#00b894;color:white}
    .connection-status.disconnected{background:#d63031;color:white}
    .controls-section{margin-bottom:30px}
    .controls-section h3{margin-bottom:15px;color:#ffeaa7;font-size:1.3rem}
    .button-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
    button{padding:15px 25px;font-size:1rem;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:1px}
    button:disabled{opacity:.4;cursor:not-allowed}
    button:not(:disabled):hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,.3)}
    button:not(:disabled):active{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,#6c5ce7,#a29bfe);color:white}
    .btn-success{background:linear-gradient(135deg,#00b894,#00cec9);color:white}
    .btn-warning{background:linear-gradient(135deg,#fdcb6e,#ffeaa7);color:#2d3436}
    .btn-danger{background:linear-gradient(135deg,#d63031,#ff7675);color:white}
    .btn-info{background:linear-gradient(135deg,#0984e3,#74b9ff);color:white}
    .input-group{display:flex;gap:10px;margin-bottom:15px}
    input[type=number]{flex:1;padding:12px;font-size:1rem;border:2px solid rgba(255,255,255,.2);border-radius:10px;background:rgba(255,255,255,.1);color:white;outline:none}
    input[type=number]:focus{border-color:#74b9ff}
    .timestamp-input{width:100%;padding:12px;font-size:1rem;border:2px solid rgba(255,255,255,.2);border-radius:10px;background:rgba(255,255,255,.1);color:white;margin-bottom:10px}
    .timestamp-input:focus{border-color:#74b9ff;outline:none}

    #fakeBtn{padding:12px 18px;border-radius:10px;font-weight:800;font-size:1rem;background:linear-gradient(135deg,#ff6b6b,#ff4757);color:#fff;border:none;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:all .3s ease}
    #fakeBtn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 10px 25px rgba(255,107,107,.5)}
    @keyframes fake-jiggle{0%{transform:translateY(0) rotate(0)}20%{transform:translateY(-6px) rotate(-3deg)}40%{transform:translateY(6px) rotate(3deg)}60%{transform:translateY(-4px) rotate(-2deg)}80%{transform:translateY(3px) rotate(1deg)}100%{transform:translateY(0) rotate(0)}}
    .jiggle{animation:fake-jiggle .8s cubic-bezier(.36,.07,.19,.97)}
    
    .connection-log{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:15px;margin-top:20px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:0.85rem}
    .log-entry{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .log-entry:last-child{border-bottom:none}
    .log-success{color:#00b894}
    .log-error{color:#ff7675}
    .log-info{color:#74b9ff}
    .log-warning{color:#fdcb6e}
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ INNOVEX CONTROLLER</h1>
    <p class="subtitle">Remote Countdown Control System</p>

    <div class="status-box">
      <h2>üì° Connection Status</h2>
      <div class="status-item">
        <span class="status-label">WebSocket:</span>
        <span class="connection-status disconnected" id="connectionStatus">Disconnected</span>
      </div>
      <div class="connection-log" id="connectionLog">
        <div class="log-entry log-info">Waiting for connection...</div>
      </div>
    </div>

    <div class="status-box">
      <h2>üñ•Ô∏è Server State</h2>
      <div class="status-item"><span class="status-label">Clock Running:</span><span class="status-value" id="stateRunning">false</span></div>
      <div class="status-item"><span class="status-label">Video Playing:</span><span class="status-value" id="stateVideo">false</span></div>
      <div class="status-item"><span class="status-label">Video Type:</span><span class="status-value" id="stateVideoType">none</span></div>
      <div class="status-item"><span class="status-label">End Timestamp:</span><span class="status-value" id="stateEndTime">null</span></div>
      <div class="status-item"><span class="status-label">Paused Remaining:</span><span class="status-value" id="statePaused">null</span></div>
      <div class="status-item"><span class="status-label">Pending Clock:</span><span class="status-value" id="statePending">null</span></div>
    </div>

    <div class="controls-section">
      <h3>üîî Fake Button</h3>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button id="fakeBtn">üéõÔ∏è FAKE BUTTON</button>
        <div style="opacity:.9;flex:1;min-width:250px">Sends <code>fake-press</code> to displays (they jiggle then start teaser)</div>
      </div>
    </div>

    <div class="controls-section">
      <h3>üé¨ Video Controls</h3>
      <div class="button-grid">
        <button class="btn-primary" id="btnPlayTeaser" disabled>‚ñ∂Ô∏è Play Teaser</button>
        <button class="btn-info" id="btnPlayVideo" disabled>‚ñ∂Ô∏è Play Video</button>
        <button class="btn-warning" id="btnSkipVideo" disabled>‚è≠Ô∏è Skip Video</button>
        <button class="btn-danger" id="btnStopVideo" disabled>‚èπÔ∏è Stop Video</button>
      </div>
    </div>

    <div class="controls-section">
      <h3>‚è±Ô∏è Clock Controls</h3>
      <div class="button-grid">
        <button class="btn-success" id="btnStartClock" disabled>üöÄ Start Clock (24h)</button>
        <button class="btn-warning" id="btnPauseClock" disabled>‚è∏Ô∏è Pause Clock</button>
        <button class="btn-info" id="btnResumeClock" disabled>‚ñ∂Ô∏è Resume Clock</button>
        <button class="btn-danger" id="btnStopClock" disabled>‚èπÔ∏è Stop Clock</button>
      </div>
    </div>

    <div class="controls-section">
      <h3>‚è≤Ô∏è Set Remaining Time</h3>
      <div class="input-group">
        <input type="number" id="inputMinutes" placeholder="Enter minutes" min="0" step="1" value="60">
        <button class="btn-info" id="btnSetRemaining" disabled>Set Minutes</button>
      </div>
    </div>

    <div class="controls-section">
      <h3>üîÑ Sync with Exact Timestamp</h3>
      <input type="datetime-local" class="timestamp-input" id="inputTimestamp">
      <button class="btn-primary" id="btnSyncTimestamp" disabled style="width:100%">Sync Timestamp</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionLog = document.getElementById('connectionLog');
    const stateRunning = document.getElementById('stateRunning');
    const stateVideo = document.getElementById('stateVideo');
    const stateVideoType = document.getElementById('stateVideoType');
    const stateEndTime = document.getElementById('stateEndTime');
    const statePaused = document.getElementById('statePaused');
    const statePending = document.getElementById('statePending');

    const fakeBtn = document.getElementById('fakeBtn');
    const btnPlayTeaser = document.getElementById('btnPlayTeaser');
    const btnPlayVideo = document.getElementById('btnPlayVideo');
    const btnSkipVideo = document.getElementById('btnSkipVideo');
    const btnStopVideo = document.getElementById('btnStopVideo');
    const btnStartClock = document.getElementById('btnStartClock');
    const btnPauseClock = document.getElementById('btnPauseClock');
    const btnResumeClock = document.getElementById('btnResumeClock');
    const btnStopClock = document.getElementById('btnStopClock');
    const btnSetRemaining = document.getElementById('btnSetRemaining');
    const btnSyncTimestamp = document.getElementById('btnSyncTimestamp');
    const inputMinutes = document.getElementById('inputMinutes');
    const inputTimestamp = document.getElementById('inputTimestamp');

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = 'log-entry log-' + type;
      entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      connectionLog.appendChild(entry);
      connectionLog.scrollTop = connectionLog.scrollHeight;
      
      // Keep only last 20 entries
      while (connectionLog.children.length > 20) {
        connectionLog.removeChild(connectionLog.firstChild);
      }
    }

    function enableAllButtons() {
      fakeBtn.disabled = false;
      btnPlayTeaser.disabled = false;
      btnPlayVideo.disabled = false;
      btnSkipVideo.disabled = false;
      btnStopVideo.disabled = false;
      btnStartClock.disabled = false;
      btnPauseClock.disabled = false;
      btnResumeClock.disabled = false;
      btnStopClock.disabled = false;
      btnSetRemaining.disabled = false;
      btnSyncTimestamp.disabled = false;
    }
    
    function disableAllButtons() {
      fakeBtn.disabled = true;
      btnPlayTeaser.disabled = true;
      btnPlayVideo.disabled = true;
      btnSkipVideo.disabled = true;
      btnStopVideo.disabled = true;
      btnStartClock.disabled = true;
      btnPauseClock.disabled = true;
      btnResumeClock.disabled = true;
      btnStopClock.disabled = true;
      btnSetRemaining.disabled = true;
      btnSyncTimestamp.disabled = true;
    }

    socket.on('connect', () => {
      console.log('CONTROLLER: Connected to server');
      connectionStatus.textContent = 'Connected';
      connectionStatus.className = 'connection-status connected';
      addLog('Connected to server', 'success');
      enableAllButtons();
    });

    socket.on('disconnect', () => {
      console.log('CONTROLLER: Disconnected from server');
      connectionStatus.textContent = 'Disconnected';
      connectionStatus.className = 'connection-status disconnected';
      addLog('Disconnected from server', 'error');
      disableAllButtons();
    });

    socket.on('state-update', (st) => {
      console.log('CONTROLLER: State update:', st);
      stateRunning.textContent = st.running ? 'true' : 'false';
      stateVideo.textContent = st.videoPlaying ? 'true' : 'false';
      stateVideoType.textContent = st.videoType || 'none';
      stateEndTime.textContent = st.endTimestamp ? (new Date(st.endTimestamp)).toLocaleString() : 'null';
      statePaused.textContent = st.pausedRemaining != null ? Math.floor(st.pausedRemaining/60000) + 'm ' + Math.floor((st.pausedRemaining%60000)/1000) + 's' : 'null';
      statePending.textContent = st.pendingClockMs != null ? Math.floor(st.pendingClockMs/3600000) + 'h' : 'null';
    });

    // Fake button with proper acknowledgment handling
    fakeBtn.addEventListener('click', () => {
      if (fakeBtn.disabled) return;
      
      console.log('CONTROLLER: Fake button clicked');
      fakeBtn.classList.remove('jiggle');
      void fakeBtn.offsetWidth;
      fakeBtn.classList.add('jiggle');

      socket.emit('fake-press');
      addLog('Sent fake-press command', 'info');

      const ackTimeout = setTimeout(() => {
        console.warn('CONTROLLER: No server ack for fake-press in 2s');
        addLog('No acknowledgment received (timeout)', 'warning');
      }, 2000);

      socket.once('fake-press-ack', (data) => {
        clearTimeout(ackTimeout);
        console.log('CONTROLLER: Server ack received:', data);
        addLog('Command acknowledged by server', 'success');
        fakeBtn.textContent = 'üéõÔ∏è FAKE BUTTON ‚úì';
        setTimeout(()=> fakeBtn.textContent = 'üéõÔ∏è FAKE BUTTON', 1200);
      });
    });

    // Button event listeners
    btnPlayTeaser.addEventListener('click', ()=> {
      if (btnPlayTeaser.disabled) return;
      console.log('CONTROLLER: Play Teaser clicked');
      socket.emit('play-teaser', { ms: 24*60*60*1000 });
      addLog('Play teaser command sent (24h clock pending)', 'info');
    });

    btnPlayVideo.addEventListener('click', ()=> {
      if (btnPlayVideo.disabled) return;
      console.log('CONTROLLER: Play Video clicked');
      socket.emit('play-video');
      addLog('Play video command sent', 'info');
    });

    btnSkipVideo.addEventListener('click', ()=> {
      if (btnSkipVideo.disabled) return;
      console.log('CONTROLLER: Skip Video clicked');
      socket.emit('skip-video');
      addLog('Skip video command sent', 'warning');
    });

    btnStopVideo.addEventListener('click', ()=> {
      if (btnStopVideo.disabled) return;
      console.log('CONTROLLER: Stop Video clicked');
      socket.emit('stop-video');
      addLog('Stop video command sent', 'error');
    });

    btnStartClock.addEventListener('click', ()=> {
      if (btnStartClock.disabled) return;
      console.log('CONTROLLER: Start Clock clicked');
      socket.emit('start-clock', 24*60*60*1000);
      addLog('Start clock (24h) command sent', 'success');
    });

    btnPauseClock.addEventListener('click', ()=> {
      if (btnPauseClock.disabled) return;
      console.log('CONTROLLER: Pause Clock clicked');
      socket.emit('pause-clock');
      addLog('Pause clock command sent', 'warning');
    });

    btnResumeClock.addEventListener('click', ()=> {
      if (btnResumeClock.disabled) return;
      console.log('CONTROLLER: Resume Clock clicked');
      socket.emit('resume-clock');
      addLog('Resume clock command sent', 'success');
    });

    btnStopClock.addEventListener('click', ()=> {
      if (btnStopClock.disabled) return;
      console.log('CONTROLLER: Stop Clock clicked');
      socket.emit('stop-clock');
      addLog('Stop clock command sent', 'error');
    });

    btnSetRemaining.addEventListener('click', ()=> {
      if (btnSetRemaining.disabled) return;
      const m = parseInt(inputMinutes.value);
      if (isNaN(m) || m < 0) {
        addLog('Invalid minutes value: ' + inputMinutes.value, 'error');
        alert('Enter valid minutes (0 or greater)');
        return;
      }
      socket.emit('set-remaining', m);
      addLog('Set remaining time: ' + m + ' minutes', 'success');
    });

    btnSyncTimestamp.addEventListener('click', ()=> {
      if (btnSyncTimestamp.disabled) return;
      const ts = new Date(inputTimestamp.value).getTime();
      if (!ts || isNaN(ts)) {
        addLog('Invalid timestamp value', 'error');
        alert('Enter valid datetime');
        return;
      }
      socket.emit('sync-timestamp', ts);
      addLog('Sync timestamp: ' + new Date(ts).toLocaleString(), 'success');
    });

    // Initialize timestamp input to 24h from now
    const now = new Date(); 
    now.setHours(now.getHours()+24);
    inputTimestamp.value = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);

    // Start with disabled buttons
    disableAllButtons();
    console.log('CONTROLLER: Initialized and waiting for connection');
  </script>
</body>
</html>